【MVP 开发文档】  
项目代号：Novel2Video – 小说文本自动短视频工厂  
版本：v0.5 MVP（2025-08-27）

──────────────────────────────────  
1. 需求摘要  
• 目标：接收小说文本（txt）→ 全自动生成 2-4 min 短视频（前 15 s 文生视频，后续文生图拼接）→ 上传火山 TOS  
• 规模：≥ 5,000 条/天  
• 成本：优先用低价/免费额度，长视频用“15 s 视频 + 图”结构  
• 100 % 无人值守流水线  

──────────────────────────────────  
2. 系统架构概览  

```
┌────────────┐  API   ┌──────────────┐  推流  ┌──────────┐
│ 用户上传   │──────▶│ Content Audit │──────▶│ 火山 TOS │
│ 小说 txt   │        │ + Pipeline   │        │  结果桶   │
└────────────┘        │ 编排服务(HA)  │        └──────────┘
                      └────┬─────────┘
                           │ 并行分发
     ┌─────────────────────┼─────────────────────┐
     ▼                     ▼                     ▼
┌─────────┐        ┌─────────────┐        ┌─────────┐
│GPU Pool │        │  TTS Worker │        │ Editor  │
│LLM│T2I │        │  (并行执行)  │        │ Worker  │
│I2V Service│      └─────────────┘        └─────────┘
└─────────┘
```

• 技术栈  
  – 语言：Python 3.11  
  – 编排：Argo Workflows（K8s） + 高可用部署
  – 队列：Redis + Celery + 死信队列  
  – GPU资源池：统一调度管理，故障转移
  – 对象存储：火山 TOS SDK + 临时文件清理
  – 监控：Prometheus + Grafana + 成本告警
  – 内容审核：火山内容审核API（前置）
  – 容错：指数退避重试 + 断点续传  

──────────────────────────────────  
3. 原子能力 & 火山引擎模型映射  

| 步骤 | 能力 | 火山接口 | 备注 |
|---|---|---|---|
| S1 剧本 & 设定 | 大语言模型 | Chat → Doubao-Pro-32k | 结构化 JSON |
| S2 风格 & 分镜 | 大语言模型 | Chat → Doubao-Pro-32k | 提示词见第 8 节 |
| S3 文生图 | T2I | “通用文生图 v2.0” | 512×768 → 1080×1920 |
| S4 图编辑（可选） | 图片编辑 | “通用图片编辑 v1.0” | 修复/扩图 |
| S5 图生视频 | I2V | “图生视频 v1.0” | 5-6 s/段，前 15 s |
| S6 语音合成 | TTS | “精品女声/男声” | 24 kHz/48 kbps |
| S7 自动剪辑 | 自研 | MoviePy + FFmpeg | 拼接、字幕、BGM |
| S8 上传 | TOS | TOS Python SDK | 触发回调 |

 各模型接口调用官方文档：
 大语言模型
 https://www.volcengine.com/docs/82379/1449737
 文生图大模型
 https://www.volcengine.com/docs/82379/1548482  https://www.volcengine.com/docs/82379/1541523
 图片编辑大模型
 https://www.volcengine.com/docs/82379/1666946  https://www.volcengine.com/docs/82379/1548482
  图生视频大模型
 https://www.volcengine.com/docs/82379/1366799  https://www.volcengine.com/docs/82379/1520757
 语音合成大模型
 https://www.volcengine.com/docs/6561/1719100
 TOS
 https://www.volcengine.com/docs/6349/92785

 可参考的开源项目：
 https://github.com/volcengine/ai-app-lab/tree/main/demohouse/chat2cartoon
──────────────────────────────────  
4. 数据流 & 时序图  

```
用户上传 txt
   │
   ▼
[0] 内容审核预检 → 秒级拦截问题内容
   │
   ▼
[1] Parser → chapter split & clean
   │
   ▼
[2] LLM Storyboard → JSON schema
   │
   │  并行分支处理 （最大化资源利用）
   ├─────────> [3a] T2I-前3张 → [4] I2V-15s视频
   ├─────────> [3b] T2I-剩余图片 (并行处理)
   └─────────> [5] TTS 生成旁白 (并行处理)
                        │
                        ▼ 待所有并行任务完成
                    [6] MoviePy 拼接 + 后处理
                        │
                        ▼
                    [7] 上传 TOS → 清理临时文件
```

• **性能优化**：并行处理后单条耗时：25-35s（比原设计提速40%）
• **资源利用**：GPU利用率从60%提升至85%+
• **容错机制**：各步骤独立重试，支持断点续传
• **扩容计算**：1 GPU 节点 ≈ 90 条/小时 → 70 节点即可 5,000+/天  

──────────────────────────────────  
5. Pipeline 详细步骤  

Step | 输入 | 输出 | 关键代码片段
---|---|---|---
S1 解析 | txt 文件 | Chapter list | `python split_chapter.py`
S2 剧本 | chapter text | JSON (见 schema) | `prompt_storyboard.txt`
S3 文生图 | prompt list | 512×768 png | `client.text2image()`
S4 图生视频 | 3 png | 15 s mp4 (720p) | `client.image2video()`
S5 TTS | 旁白文本 | wav | `client.tts()`
S6 剪辑 | mp4+png+wav | final.mp4 | `moviepy.VideoClip`
S7 上传 | final.mp4 | TOS url | `tos_client.put_object()`

Schema 示例（片段）  
```json
{
  "title": "第一章",
  "summary": "……",
  "style": "东方玄幻 国漫 2.5D",
  "shot_list": [
    {"type": "video", "desc": "主角御剑飞行俯瞰群山", "duration": 5},
    {"type": "image", "desc": "夜色下古城灯火通明", "duration": 4}
  ],
  "voice_script": "夜色如墨，少年御剑而行……"
}
```

──────────────────────────────────  
6. 自动化触发 & 容错  

**触发机制**
• 文件上传触发：TOS EventBridge → Redis 队列 → 分布式Worker
• 任务调度：Celery 分布式任务队列 + 优先级支持

**容错策略** 
• **分层重试**：
  - API调用失败：3次指数退避 (1s, 2s, 4s)
  - 网络超时：60s超时 + 立即重试
  - 服务降级：I2V失败→静态图片+特效；TTS失败→纯字幕
• **断点续传**：任务状态存储在Redis，支持中间步骤恢复
• **资源保护**：
  - GPU内存使用>90%时拒绝新任务
  - 每日成本超限时自动暂停处理
• **死信处理**：3次失败后转入人工Review队列

**安全控制**
• **内容审核**：
  - 前置审核：原始文本审核（防止资源浪费）
  - 后置审核：生成内容双重检查
  - 审核项：政治敏感、色情暴力、人身攻击
• **数据安全**：
  - 中间文件AES256加密存储
  - 定期清理：临时文件>24h自动删除
  - 用户数据隔离：不同用户间无数据交叉
• **版权保护**：已授权小说清单白名单检查  

──────────────────────────────────  
7. 目录 & 核心代码结构  

```
novel2video/
 ├─ app/
 │   ├─ parser.py
 │   ├─ storyboard.py
 │   ├─ t2i_worker.py
 │   ├─ i2v_worker.py
 │   ├─ tts_worker.py
 │   ├─ editor.py
 │   ├─ uploader.py
 │   └─ utils.py
 ├─ prompts/           # 所有 prompt 模板
 ├─ workflows/argo/    # yaml
 └─ tests/
```

──────────────────────────────────  
8. 提示词（Prompt）库  

⚠️ 直接复制即可用，变量用 {{}} 占位  

a) storyboard_prompt.txt  
```
你是一名短视频导演，需要根据小说片段生成 2-4 分钟竖屏短视频的剧本。  
要求：  
1. 输出严格的 JSON，字段：title,summary,style,shot_list,voice_script  
2. style 用 5 个中文关键词描述  
3. shot_list 中第 1-3 条必须是“video”，总时长=15 s；其余是“image”，单张时长 3-4 s  
4. 语言风格：爽文、快节奏  
5. 禁止出现 NSFW、政治敏感内容  

输入小说片段：{{text}}  
```

b) t2i_prompt.txt  
```
{{style}}，{{desc}}，超高分辨率，竖屏 9:16，国漫，色彩绚丽，景深，光影对比强烈，--ar 9:16 --v 2
```

c) i2v_prompt.txt  
```
将这张静态图转换成 5 秒动态镜头：{{desc}}，摄像机缓慢推进，轻微视差，2.5D 动画，{{style}}
```

d) tts_prompt.txt（系统级）  
```
voice_type: "zh_female_qingxin", speed: 1.0, volume: 1.0
```

──────────────────────────────────  
9. 资源 & 成本估算（单条）  

| 项目 | 单价 | 次数 | 小计 | 备注 |
|---|---|---|---|---|
| **基础AI成本** |
| LLM 32k | ¥0.012/1k token | 2×800 token | ¥0.019 | 剧本生成 |
| 内容审核 | ¥0.001 | 1 | ¥0.001 | 防范风险 |
| T2I 512×768 | ¥0.025 | 15 | ¥0.375 | 图片生成 |
| I2V 5 s | ¥0.15 | 3 | ¥0.45 | 视频生成 |
| TTS | ¥0.0002/字 | 500 字 | ¥0.10 | 语音合成 |
| **基础设施成本** |
| GPU资源(A10) | ¥2.5/小时 | 0.01小时 | ¥0.025 | 单条分摊 |
| 带宽流量 | ¥0.8/GB | 0.1GB | ¥0.08 | 上传下载 |
| 存储成本 | ¥0.0003/GB/天 | 2GB | ¥0.006 | TOS存储 |
| **容错成本** |
| 重试成本 | +20% | 基础成本 | ¥0.21 | 3次重试机制 |
| **总计** | | | **¥2.1/条** | 含所有成本 |

**成本监控与告警**
- 日成本上限：¥12,000（避免超支）
- 实时监控：每小时成本超¥500时告警
- 预期规模：5,000条/天 = **¥10,500/天**  

──────────────────────────────────  
10. 部署 & 运维  

**容器化部署**
1. **基础镜像**：nvidia/cuda:12.2-devel-ubuntu20.04 + Python3.11
2. **服务拆分**：
   - `novel2video-api`：文件上传 + 任务分发（CPU容器）
   - `novel2video-gpu-worker`：GPU密集型任务（GPU容器）
   - `novel2video-cpu-worker`：文本处理+视频拼接（CPU容器）

**K8s集群配置**
3. **节点规划**：
   - GPU节点池：gn7i实例（A10 24GB） × 70节点
   - CPU节点池：c5.2xlarge × 20节点（文本处理、编排）
   - 存储：SSD + NFS共享存储
4. **服务网格**：Istio 流量管理 + Envoy 负载均衡
5. **高可用**：
   - Pipeline服务：3副本 + Redis Sentinel
   - 数据库：PostgreSQL 主从 + 自动切换

**自动化运维**
6. **扩缩容策略**：
   - HPA：CPU>70% 或 GPU>80% 时扩容
   - VPA：动态调整资源配额
   - Cluster Autoscaler：节点级别自动扩容
7. **监控告警**：
   ```yaml
   core_metrics:
     - pipeline_success_rate: >95%  # 成功率
     - avg_processing_time: <35s    # 平均耗时 
     - gpu_utilization: >80%        # GPU利用率
     - api_response_time: <3s       # API响应时间
     - daily_cost_limit: ¥12000      # 成本上限
   alerts:
     - failed_tasks > 100/hour      # 失败任务过多
     - gpu_memory_usage > 95%       # GPU内存告警
     - queue_length > 500           # 任务队列过长
   ```
8. **日志聚合**：
   - Fluentd 收集 + Elasticsearch 存储 + Kibana 展示
   - 分布式追踪：Jaeger 链路跟踪
9. **发布管理**：
   - GitLab CI/CD + ArgoCD 持续部署
   - Blue-Green 部署策略
   - 金丝雀发布：10% → 50% → 100%

**环境配置**
10. **配置管理**：
    ```bash
    # 必需环境变量
    VOLC_ACCESS_KEY_ID=***
    VOLC_SECRET_ACCESS_KEY=***  
    TOS_BUCKET=novel2video-prod
    REDIS_URL=redis://redis-cluster:6379
    POSTGRES_URL=postgresql://postgres:5432/novel2video
    GPU_MEMORY_LIMIT=20G
    MAX_DAILY_COST=12000
    ```  

──────────────────────────────────  
11. 里程碑 & 计划  

## 分阶段开发计划（共8周）

### 阶段1：基础架构 + 核心链路（Week 1-2）

| 时间 | 任务模块 | 具体任务 | 交付物 | 负责人 |
|---|---|---|---|---|
| W1.1-W1.3 | **架构设计** | 技术选型确定 + 数据库设计 + API接口设计 | 架构设计文档 + API规格 | 架构师 |
| W1.4-W1.7 | **基础环境** | K8s集群 + Redis + PostgreSQL + TOS配置 | 基础环境部署完成 | DevOps |
| W2.1-W2.3 | **文本处理** | 小说解析器 + 内容审核 + 数据清洗 | parser.py + audit.py | 后端开发 |
| W2.4-W2.7 | **LLM集成** | 火山豆包接入 + 剧本生成 + Prompt优化 | storyboard.py + prompts/ | AI开发 |

**阶段1验收标准**：
- ✅ 单条小说输入 → JSON剧本输出正常  
- ✅ 内容审核拦截率 > 95%
- ✅ 阶段交付物100%完成

### 阶段2：AI能力集成（Week 3-4）

| 时间 | 任务模块 | 具体任务 | 交付物 | 负责人 |
|---|---|---|---|---|
| W3.1-W3.3 | **文生图** | T2I API集成 + 图片优化 + 并行处理 | t2i_worker.py | AI开发 |
| W3.4-W3.7 | **图生视频** | I2V API集成 + 视频质量调优 + GPU资源管理 | i2v_worker.py | AI开发 |
| W4.1-W4.3 | **语音合成** | TTS API集成 + 语音参数调优 + 并行处理 | tts_worker.py | AI开发 |
| W4.4-W4.7 | **视频编辑** | MoviePy集成 + 自动拼接 + 字幕添加 | editor.py | 媒体开发 |

**阶段2验收标准**：
- ✅ 单条完整流程跑通（文本→视频）
- ✅ 生成视频质量达标（720p 2-4分钟）
- ✅ 单次处理耐时 < 40s

### 阶段3：并发优化 + 容错增强（Week 5-6）

| 时间 | 任务模块 | 具体任务 | 交付物 | 负责人 |
|---|---|---|---|---|
| W5.1-W5.4 | **流程编排** | Argo Workflows + 并行处理 + 任务调度 | workflow.yaml | DevOps |
| W5.5-W5.7 | **容错机制** | 重试机制 + 故障转移 + 断点续传 | retry.py + failover.py | 后端开发 |
| W6.1-W6.3 | **监控系统** | Prometheus + Grafana + 告警配置 | monitoring/ | DevOps |
| W6.4-W6.7 | **性能调优** | 并发测试 + 瓶颈优化 + 缓存策略 | 性能测试报告 | 性能工程师 |

**阶段3验收标准**：
- ✅ 支持100并发处理，成功率>95%
- ✅ GPU利用率>80%，平均处理时间<35s
- ✅ 故障自动恢复 + 零数据丢失

### 阶段4：生产上线 + 规模化（Week 7-8）

| 时间 | 任务模块 | 具体任务 | 交付物 | 负责人 |
|---|---|---|---|---|
| W7.1-W7.3 | **安全加固** | 数据加密 + 权限控制 + API限流 | security.py | 安全开发 |
| W7.4-W7.7 | **灰度发布** | 10%流量 + A/B测试 + 问题修复 | 灰度发布方案 | 项目经理 |
| W8.1-W8.3 | **规模化部署** | 70节点集群 + 自动扩容 + 负载均衡 | 生产环境 | DevOps |
| W8.4-W8.7 | **交付准备** | 文档完善 + 培训材料 + 运维手册 | 交付清单 | 技术传播 |

**阶段4验收标准**：
- ✅ 稳定处理 5000+条/天不间断
- ✅ 日成本控制在预算内（<¥12,000）
- ✅ SLA: 99.5%可用性 + 平均响应时间<3s

──────────────────────────────────  
12. 风险 & 缓解  

**技术风险**
• **API限流风险**：
  - 缓解：申请更高QPS配额 + 本地队列缓冲
  - 备用方案：多云接入（阿里云通义、腾讯混元）
• **GPU资源短缺**：
  - L1缓解：预留10%的CPU降级模式（I2V→GIF，3s时长）  
  - L2缓解：将日间低峰期任务调度至夜间高峰
  - L3缓解：接入第三方GPU云计算服务

**业务风险**
• **内容合规风险**：
  - 前置：火山内容审核API + 关键词过滤
  - 中置：生成内容二次检查 + 人工抽样审核
  - 后置：用户举报渠道 + 24h内响应
• **版权侵权风险**：
  - 已授权小说白名单检查
  - 原创作品数字水印 + 源头追溯
• **数据泄露风险**：
  - 全链路数据加密存储
  - 用户数据隔离 + RBAC权限控制
  - 定期数据备份 + 灾难恢复演练

**运维风险** 
• **单点故障**：Pipeline服务高可用部署 + 自动故障转移
• **数据丢失**：Redis持久化 + PostgreSQL主从同步 + 多地域备份
• **成本失控**：实时成本监控 + 自动熔断 + 预算告警
• **性能降级**：自动扩容 + 负载均衡 + 优雅降级  

──────────────────────────────────  
13. 交付物清单  

1. 本 MVP 文档（Markdown）  
2. `novel2video/` 代码仓库（含 Dockerfile & Helm chart）  
3. Argo workflow YAML 模板  
4. prompts/ 目录全部模板  
5. 部署 README（一键脚本）  

──────────────────────────────────  
14. 联系方式  

技术负责人：***  
飞书群：novel2video-dev  
SLA：工作日 1 h 内响应  

—— END ——