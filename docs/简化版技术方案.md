# 小说转视频自动化工具 - 简化版技术方案

**项目名称**：auto_movie  
**版本**：v1.0 简化版  
**适用场景**：个人使用，小批量处理  
**开发周期**：1-2周  
**开发人员**：1人  

---

## 1. 项目概述

**目标**：将小说txt文件转换为2-4分钟的竖屏短视频  
**处理量**：100-500条/天（按需处理）  
**架构**：单机Python脚本，简单易用  

## 2. 系统架构

```
输入txt文件 → Python脚本处理 → 输出MP4视频
     ↓
┌─────────────┐
│  文本解析    │ ─→ 章节分割、内容清理
├─────────────┤
│  LLM生成剧本 │ ─→ 调用豆包API生成分镜
├─────────────┤  
│  并行处理    │ ─┬→ 文生图(15张)
│             │  ├→ 图生视频(前3张)
│             │  └→ 语音合成
├─────────────┤
│  视频合成    │ ─→ 拼接图片视频+音频
├─────────────┤
│  上传存储    │ ─→ 火山TOS/本地存储
└─────────────┘
```

## 3. 技术栈选择

**核心语言**：Python 3.9+  
**AI接口**：火山引擎API (豆包LLM + 文生图 + 图生视频 + TTS)  
**视频处理**：MoviePy + FFmpeg  
**数据存储**：SQLite (本地数据库)  
**配置管理**：YAML配置文件  
**依赖管理**：pip + requirements.txt  

## 4. 目录结构

```
auto_movie/
├── main.py              # 主程序入口
├── config.yaml          # 配置文件
├── requirements.txt     # Python依赖
├── processors/          # 核心处理模块
│   ├── __init__.py
│   ├── parser.py        # 文本解析
│   ├── llm_client.py    # LLM调用
│   ├── image_gen.py     # 文生图
│   ├── video_gen.py     # 图生视频
│   ├── tts_client.py    # 语音合成
│   └── video_editor.py  # 视频编辑合成
├── prompts/             # 提示词模板
│   ├── storyboard.txt   # 分镜提示词
│   ├── image_prompt.txt # 图片生成提示词
│   └── video_prompt.txt # 视频生成提示词
├── utils/               # 工具函数
│   ├── __init__.py
│   ├── file_utils.py    # 文件处理
│   ├── api_utils.py     # API调用工具
│   └── logger.py        # 日志工具
├── data/                # 数据目录
│   ├── database.db      # SQLite数据库
│   ├── temp/            # 临时文件
│   └── output/          # 输出视频
└── logs/                # 日志文件
    └── app.log
```

## 5. 核心功能模块

### 5.1 文本解析 (parser.py)
```python
# 功能：
- 读取txt文件
- 自动章节分割
- 文本清理和格式化
- 长度控制(适合2-4分钟视频)

# 输出：
{
    "title": "第一章",
    "content": "清理后的文本内容...",
    "word_count": 1500
}
```

### 5.2 剧本生成 (llm_client.py)
```python
# 功能：
- 调用豆包API生成分镜脚本
- JSON格式输出
- 错误重试机制

# 输出示例：
{
    "title": "第一章",
    "summary": "故事摘要",
    "style": "古风 国漫 唯美",
    "shots": [
        {"type": "video", "desc": "主角御剑飞行", "duration": 5},
        {"type": "image", "desc": "古城夜景", "duration": 3}
    ],
    "narration": "旁白文本..."
}
```

### 5.3 图片生成 (image_gen.py)
```python
# 功能：
- 批量调用文生图API
- 自动重试失败的图片
- 图片质量检查
- 尺寸统一处理(9:16)
```

### 5.4 视频生成 (video_gen.py)
```python
# 功能：
- 前3张图片转为15秒视频
- 剩余图片保持静态
- 视频质量控制
```

### 5.5 语音合成 (tts_client.py)
```python
# 功能：
- 旁白文字转语音
- 语音参数调节
- 音频格式标准化
```

### 5.6 视频合成 (video_editor.py)
```python
# 功能：
- 视频片段拼接
- 图片转视频(静态)
- 音频轨道合成
- 字幕添加
- 输出MP4格式
```

## 6. 配置文件 (config.yaml)

```yaml
# API配置
api:
  volcengine:
    access_key: "your_access_key"
    secret_key: "your_secret_key"
    
# 模型配置  
models:
  llm: "ep-20241230140000-xxxxx"    # 豆包模型endpoint
  text2image: "general_v2.0"        # 文生图模型
  image2video: "image2video_v1.0"   # 图生视频模型
  tts: "zh_female_qingxin"          # TTS语音模型

# 生成参数
generation:
  max_images: 15              # 最大图片数
  video_segments: 3           # 视频片段数(前3张)
  image_size: "512x768"       # 图片尺寸
  video_duration: 5           # 单段视频时长
  output_resolution: "720p"   # 输出分辨率

# 存储配置
storage:
  local_output: "./data/output"
  temp_dir: "./data/temp"
  tos_bucket: "your-bucket"   # 可选：上传到TOS

# 重试配置
retry:
  max_attempts: 3
  base_delay: 1
  max_delay: 10
```

## 7. 主程序流程 (main.py)

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import asyncio
from pathlib import Path
from processors import *
from utils import Logger, load_config

async def process_novel(txt_file: str):
    """处理单个小说文件"""
    
    logger = Logger()
    config = load_config("config.yaml")
    
    # 1. 解析文本
    logger.info(f"开始处理: {txt_file}")
    parser = TextParser()
    text_data = parser.parse(txt_file)
    
    # 2. 生成剧本
    llm = LLMClient(config)
    script = await llm.generate_script(text_data)
    
    # 3. 并行生成素材
    tasks = [
        generate_images(script, config),
        generate_videos(script, config), 
        generate_audio(script, config)
    ]
    images, videos, audio = await asyncio.gather(*tasks)
    
    # 4. 合成最终视频
    editor = VideoEditor(config)
    final_video = editor.compose(images, videos, audio, script)
    
    logger.info(f"处理完成: {final_video}")
    return final_video

if __name__ == "__main__":
    import sys
    if len(sys.argv) != 2:
        print("用法: python main.py <小说文件.txt>")
        sys.exit(1)
        
    txt_file = sys.argv[1]
    result = asyncio.run(process_novel(txt_file))
    print(f"视频已生成: {result}")
```

## 8. 安装和使用

### 8.1 环境准备
```bash
# 克隆项目
git clone <project-url>
cd auto_movie

# 安装依赖
pip install -r requirements.txt

# 配置API密钥
cp config.yaml.example config.yaml
# 编辑 config.yaml，填入你的火山引擎API密钥
```

### 8.2 使用方式
```bash
# 处理单个文件
python main.py "小说.txt"

# 批量处理
python batch_process.py "novels/" "output/"
```

## 9. 成本估算

**单条视频成本** (简化版):
- LLM调用: ¥0.02
- 文生图(15张): ¥0.38  
- 图生视频(3段): ¥0.45
- TTS语音: ¥0.10
- **总计: ≈¥0.95/条**

**对比原方案**:
- 原方案: ¥2.1/条 (含基础设施)
- 简化版: ¥0.95/条 (纯API成本)
- **节省55%成本**

## 10. 优势对比

| 方面 | 原方案(工程版) | 简化版 |
|------|---------------|--------|
| **开发时间** | 8周 | 1-2周 |
| **团队规模** | 6-8人 | 1人 |
| **技术复杂度** | 极高 | 低 |
| **部署难度** | 需K8s专家 | pip install |
| **维护成本** | 需专职运维 | 几乎无 |
| **启动成本** | >¥50万 | <¥5千 |
| **处理能力** | 5000条/天 | 100-500条/天 |
| **适用场景** | 商业产品 | 个人工具 |

## 11. 扩展计划

**如果后续需要提升处理量**:
1. **多进程版本** → 支持1000条/天
2. **Docker版本** → 一键部署  
3. **Web界面版** → 可视化操作
4. **云函数版** → 按需付费

---

**总结**: 这个简化方案保留了核心功能，大幅降低了技术复杂度和开发成本，非常适合个人使用场景。你可以先按这个方案快速开发出MVP，后续再根据实际需求逐步扩展。