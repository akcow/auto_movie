# 通用2.0文生图模型提示词优化说明

## 📋 概述

根据火山引擎通用2.0文生图模型的官方建议，我们已完全重构了提示词构建系统，采用更科学、更有效的提示词结构。

## 🔄 主要改进

### 1. 新的提示词结构
按照官方推荐的顺序组织提示词：
**场景 → 角色 → 构图 → 动作 → 风格**

### 2. 智能解析系统
- 自动识别描述中的场景、角色、构图、动作元素
- 智能映射风格关键词
- 添加质量控制和安全提示词

### 3. 安全合规
- 使用"圆领袍"避免V领问题
- 添加高领服饰提示词
- 避免敏感和违规内容

## 📝 提示词结构详解

### 推荐顺序和权重
```
场景描述 → 角色描述 → 构图描述 → 动作描述 → 风格描述
   (高)    →    (高)    →    (中)    →    (中)    →   (低)
```

**注意**: 越靠前的提示词模型注意力越高，提示词越多、靠后的提示词遵从度会降低。

### 1. 场景描述（最高优先级）
**作用**: 明确场景位置，为整个画面设定基础

**要求**:
- 使用白话文描述
- 不要使用代词
- 避免具体的地名、人名

**示例**:
- ✅ `庭院内`
- ✅ `森林中` 
- ✅ `海边悬崖`
- ❌ `天魔教地牢内` (模型不知道的地方)
- ❌ `林威的家` (包含人名)

### 2. 角色描述（高优先级）
**作用**: 描述画面的主体内容

**要求**:
- 明确描述人物特征
- 避免使用人名
- 使用具体的服饰描述

**示例**:
- ✅ `一位穿白色圆领袍的女性`
- ✅ `一位黑发凌乱的男性`
- ❌ `林威` (模型不知道是谁)
- ❌ `穿着汉服的女子` (连带概念，偏向国风)

### 3. 构图描述（中等优先级）
**作用**: 确定整体构图和视角

**示例**:
- ✅ `电影般的意境角度`
- ✅ `电影级低视角拍摄`
- ✅ `细致的脸特写`
- ❌ `细致的脸` (可能偏向大脸照)

### 4. 动作描述（中等优先级）
**作用**: 描述人物的动作状态

**要求**:
- 使用简单、具体的动作
- 避免复杂的动作描述

**示例**:
- ✅ `站立着`
- ✅ `坐着`
- ✅ `正在行走`
- ❌ `悬浮在水下正在看书` (复杂动作易出问题)

### 5. 风格描述（较低优先级）
**作用**: 影响全局氛围和风格

**风格映射**:
- `古风` → `古风言情动漫风格`
- `写实` → `写实照片风格`
- `动漫` → `二次元动漫手绘`
- `唯美` → `唯美治愈风`
- `仙侠` → `古风仙侠风格`

## ⚠️ 重要注意事项

### 1. 避免连带概念
某些词汇会产生"连带概念"，影响生成效果：

| 词汇 | 连带概念 | 建议 |
|------|----------|------|
| 汉服 | 偏向国风，V字领 | 使用"圆领袍" |
| 细致的脸 | 偏向大脸照 | 使用"电影级构图" |
| 细腻的皮肤 | 可能暴露身体 | 使用"高领服饰" |
| standing | 偏向全身照 | 使用"站立着" |

### 2. 服装安全要求
为避免违规图片，特别注意：

**V领问题**:
- **积极词**: `圆领袍`、`高领服饰`
- **屏蔽词**: `中式古典汉服`、`V领古典服饰`、`深V`、`锁骨`

**胸部问题**:
- 避免使用: `发育`、`成熟女性`、`成熟`
- 积极词: `petite body`、`未发育`

### 3. 使用白话文
模型知识库能理解一般知道的事物，但不要使用：
- 专有名词
- 代词
- 模型不知道的概念

## 🛠️ 代码实现

### 新增方法

#### `_build_image_prompt()`
按照推荐结构构建提示词：
```python
def _build_image_prompt(self, description: str, style: str) -> str:
    # 1. 解析描述为结构化组件
    parsed_components = self._parse_description_for_v2_model(description, style)
    
    # 2. 按推荐顺序组合
    prompt_parts = [
        parsed_components['scene'],
        parsed_components['character'],
        parsed_components['composition'], 
        parsed_components['action'],
        parsed_components['style']
    ]
    
    # 3. 添加质量控制
    quality_prompt = self._get_quality_and_safety_prompt()
    
    # 4. 组合最终提示词
    return f"{base_prompt}，{quality_prompt}"
```

#### `_parse_description_for_v2_model()`
智能解析描述内容：
```python
def _parse_description_for_v2_model(self, description: str, style: str) -> Dict[str, str]:
    # 使用关键词匹配分类描述内容
    # 返回结构化的组件字典
```

#### `_get_quality_and_safety_prompt()`
添加质量控制和安全提示词：
```python
def _get_quality_and_safety_prompt(self) -> str:
    # 积极质量词
    positive_words = [
        '超高分辨率', '竖屏9:16', '精美细节', 
        '光影对比强烈', '色彩绚丽', '高领服饰'
    ]
    return '，'.join(positive_words)
```

## 📊 测试结果示例

### 输入
```
原始描述: 古风庭院，月光如水，白衣女子独立庭院中央
原始风格: 古风 唯美 仙侠
```

### 输出
```
优化后提示词: 庭院内，一位穿白色圆领袍的女性，电影般的意境角度，静态姿势，古风言情动漫风格，超高分辨率，竖屏9:16，精美细节，光影对比强烈，色彩绚丽，专业摄影，高领服饰，圆领袍

解析组件:
  scene: 庭院内
  character: 一位穿白色圆领袍的女性
  composition: 电影般的意境角度
  action: 静态姿势
  style: 古风言情动漫风格
```

## 🚀 使用建议

### 1. 描述输入优化
- 使用简洁、具体的描述
- 避免抽象和模糊的词汇
- 确保描述适合模型理解

### 2. 风格选择
- 使用预定义的风格关键词
- 可以组合多个风格词汇
- 风格词汇越靠前权重越高

### 3. 质量控制
- 系统自动添加质量控制词
- 包含安全合规检查
- 确保适合视频制作使用

## 🧪 测试验证

### 运行测试脚本
```bash
python test_prompt_optimization.py
```

### 测试内容
- 提示词结构验证
- 组件解析准确性
- 风格映射正确性
- 输出质量检查

## 📈 性能提升

### 1. 图像质量
- 更好的图文匹配度
- 减少违规内容生成
- 提升整体视觉效果

### 2. 生成稳定性
- 标准化的提示词结构
- 减少随机性和不确定性
- 提高生成结果的一致性

### 3. 安全合规
- 自动过滤敏感内容
- 符合平台规范要求
- 降低审核失败风险

---

**总结**: 新的提示词系统完全按照通用2.0模型官方建议设计，能够显著提升图像生成质量和安全性，特别适合小说视频制作场景。