# 小说转视频自动化工具 - 详细使用指南

## 🚀 快速开始

### 1. 环境准备

#### 系统要求
- **Python**: 3.8 或以上版本
- **FFmpeg**: 4.4 或以上版本
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **内存**: 建议 2GB 以上
- **存储**: 每个视频需要约 100MB 临时空间

#### 安装依赖
```bash
# 1. 安装Python依赖
pip install -r requirements.txt

# 2. 安装FFmpeg
# Windows: 下载FFmpeg并添加到PATH环境变量
# https://ffmpeg.org/download.html

# Linux: 
sudo apt install ffmpeg

# macOS:
brew install ffmpeg

# 3. 验证FFmpeg安装
ffmpeg -version
```

#### 配置API密钥
```bash
# 复制配置文件模板
cp config.yaml.example config.yaml

# 编辑config.yaml，填入你的火山引擎API密钥
# 详细申请步骤请参考 API申请指南.md
```

### 2. 使用方式

#### 🌟 交互式模式（推荐新手）
```bash
# 启动增强版交互界面
python enhanced_main.py
```
交互式界面提供：
- 📁 文件选择器
- 📊 实时进度显示
- 🔄 错误恢复机制
- 📈 成本统计
- 🎬 结果预览

#### 💻 命令行模式（适合自动化）
```bash
# 处理单个小说文件
python main.py "小说.txt"

# 批量处理
python batch_process.py "小说目录/" --max-concurrent 2

# 查看任务状态
python main.py --status task_xxx

# 查看统计信息
python main.py --stats
python main.py --cost 2024-09-01
```

## 📁 完整项目结构

```
auto_movie/
├── 🎬 主程序入口
│   ├── enhanced_main.py           # 增强版主程序（推荐）
│   ├── main.py                    # 原版主程序
│   └── batch_process.py           # 批量处理工具
│
├── ⚙️ 配置文件
│   ├── config.yaml               # 用户配置文件
│   ├── config.yaml.example       # 配置模板
│   └── requirements.txt           # Python依赖
│
├── 📖 文档说明
│   ├── README.md                 # 项目说明
│   ├── 使用说明.md                # 详细使用指南（本文档）
│   └── API申请指南.md             # API申请说明
│
├── 🔧 核心处理模块
│   └── processors/
│       ├── parser.py             # 文本解析 ✅
│       ├── llm_client.py         # LLM调用 ✅
│       ├── image_gen.py          # 文生图 ✅
│       ├── video_gen.py          # 图生视频 ✅
│       ├── tts_client.py         # 语音合成 ✅
│       └── video_editor.py       # 视频编辑 ✅
│
├── 🛠️ 工具模块
│   └── utils/
│       ├── logger.py             # 日志系统 ✅
│       ├── file_utils.py         # 文件处理工具 ✅
│       ├── api_utils.py          # API调用工具 ✅
│       ├── database.py           # 数据库管理 ✅
│       ├── cli_interface.py      # CLI界面 ✅
│       └── error_handler.py      # 错误处理 ✅
│
├── 📝 提示词模板
│   └── prompts/
│       ├── storyboard.txt        # 分镜脚本模板
│       ├── image_prompt.txt      # 图片生成模板
│       └── video_prompt.txt      # 视频生成模板
│
├── 🧪 测试套件
│   └── tests/
│       ├── test_database.py      # 数据库测试
│       ├── test_llm_client.py    # LLM客户端测试
│       ├── test_text_parser.py   # 文本解析测试
│       ├── test_integration.py   # 集成测试
│       └── test_edge_cases.py    # 边缘情况测试
│
└── 📂 数据目录
    ├── data/
    │   ├── temp/                 # 临时文件
    │   ├── output/               # 输出视频
    │   └── database.db           # 本地数据库
    └── logs/                     # 日志文件
        └── app.log
```

## ⚙️ 配置文件详解

### 基础配置
```yaml
# API配置
api:
  volcengine:
    access_key: "你的AccessKey"
    secret_key: "你的SecretKey" 
    region: "cn-beijing"

# 模型端点配置
models:
  llm_endpoint: "你的LLM endpoint"
  text_to_image_endpoint: "你的文生图endpoint"  
  image_to_video_endpoint: "你的图生视频endpoint"
  tts_endpoint: "你的TTS endpoint"
```

### 高级配置
```yaml
# 生成参数
generation:
  max_images: 15                    # 最大图片数
  video_segments: 3                 # 视频片段数
  output_resolution: "720p"         # 输出分辨率
  final_duration_min: 120           # 最小视频时长(秒)
  final_duration_max: 240           # 最大视频时长(秒)
  
  # 图片生成配置
  image_style: "realistic"          # 图片风格: realistic/anime/cartoon
  image_quality: "high"             # 图片质量: normal/high/ultra
  
  # 视频生成配置
  video_fps: 24                     # 视频帧率
  video_quality: "high"             # 视频质量

# 成本控制
cost_control:
  enable_cost_limit: true
  daily_limit_yuan: 50              # 每日成本上限
  single_task_limit_yuan: 5         # 单任务成本上限
  
# 性能优化
performance:
  max_concurrent_requests: 3        # 最大并发请求数
  request_timeout: 300              # 请求超时时间(秒)
  retry_attempts: 3                 # 重试次数
  
# 存储配置
storage:
  temp_dir: "./data/temp"
  output_dir: "./data/output"
  auto_cleanup: true                # 自动清理临时文件
  keep_days: 7                      # 保留天数
```

## 📖 详细使用流程

### 1. 交互式使用（推荐）

#### 启动增强版界面
```bash
python enhanced_main.py
```

#### 主菜单功能
- **🎬 开始新任务**: 选择小说文件开始处理
- **📊 查看状态**: 查看任务历史和统计信息
- **⚙️ 系统设置**: 调整配置参数
- **❓ 帮助信息**: 查看使用帮助
- **🚪 退出程序**: 安全退出

#### 处理过程
1. **文件选择**: 通过文件浏览器选择txt文件
2. **预处理检查**: 自动检测文件编码和格式
3. **进度显示**: 实时显示各个处理步骤
4. **错误处理**: 遇到错误时提供恢复选项
5. **结果预览**: 完成后可预览生成的视频

### 2. 命令行使用（适合批处理）

#### 单文件处理
```bash
# 基本用法
python main.py "path/to/novel.txt"

# 指定输出目录
python main.py "novel.txt" --output-dir "my_videos/"

# 设置质量参数
python main.py "novel.txt" --image-quality high --video-fps 30
```

#### 批量处理
```bash
# 处理整个目录
python batch_process.py "novels_dir/" 

# 限制并发数和文件类型
python batch_process.py "novels_dir/" --max-concurrent 2 --pattern "*.txt"

# 生成处理报告
python batch_process.py "novels_dir/" --report "report.json"

# 跳过已处理的文件
python batch_process.py "novels_dir/" --skip-existing
```

#### 状态查询
```bash
# 查看任务历史
python main.py --list

# 查看特定任务状态
python main.py --status task_12345

# 查看统计信息
python main.py --stats

# 查看成本信息
python main.py --cost 2025-09-01
```

## 💡 最佳实践

### 1. 小说文件准备

#### 支持的格式
- **文件类型**: .txt, .md
- **编码格式**: UTF-8 (推荐), GBK, GB2312, Big5
- **文件大小**: 建议 1KB - 50KB
- **字数范围**: 500-5000 字最佳

#### 内容要求
```
推荐格式:
第一章 标题
正文内容...

第二章 标题  
正文内容...
```

#### 内容建议
- ✅ **清晰的情节描述**: 便于AI理解和生成图像
- ✅ **适量的对话**: 增加视频趣味性
- ✅ **场景描写**: 帮助生成更准确的图片
- ❌ **过多专业术语**: 可能影响AI理解
- ❌ **纯对话内容**: 缺少视觉元素

### 2. 成本控制策略

#### 测试阶段
```bash
# 使用短篇测试(推荐500字以内)
python main.py "short_test.txt"

# 设置较低的成本上限
# 在config.yaml中设置:
cost_control:
  single_task_limit_yuan: 1
```

#### 生产使用
```bash
# 批量处理前先估算成本
python batch_process.py "novels/" --estimate-cost

# 设置合理的每日限额
cost_control:
  daily_limit_yuan: 50
```

### 3. 性能优化

#### 系统资源
- **内存**: 处理时峰值约1.5GB，建议至少2GB
- **存储**: 每个视频约100MB临时空间
- **网络**: 稳定连接，建议10Mbps以上

#### 并发设置
```yaml
# 根据网络和硬件条件调整
performance:
  max_concurrent_requests: 2    # 网络较慢时设为1-2
  request_timeout: 600          # 网络不稳定时增加超时
```

## 🔧 故障排除指南

### 常见问题及解决方案

#### 1. 环境配置问题

**问题**: `ModuleNotFoundError: No module named 'xxx'`
```bash
解决方案:
pip install -r requirements.txt
# 或单独安装缺失模块
pip install xxx
```

**问题**: `FFmpeg not found`
```bash
解决方案:
# Windows: 下载FFmpeg并添加到PATH
# 验证安装: ffmpeg -version

# Linux: 
sudo apt update && sudo apt install ffmpeg

# macOS:
brew install ffmpeg
```

#### 2. API调用问题

**问题**: `401 Unauthorized`
```yaml
解决方案:
检查config.yaml中的API密钥:
api:
  volcengine:
    access_key: "正确的AccessKey"
    secret_key: "正确的SecretKey"
```

**问题**: `429 Rate Limit Exceeded`
```yaml
解决方案:
降低并发数:
performance:
  max_concurrent_requests: 1
  request_timeout: 300
```

**问题**: `余额不足`
```bash
解决方案:
1. 检查火山引擎账户余额
2. 调整成本限制:
   cost_control:
     single_task_limit_yuan: 2
```

#### 3. 文件处理问题

**问题**: `UnicodeDecodeError`
```bash
解决方案:
1. 确保文件编码为UTF-8
2. 使用记事本另存为UTF-8格式
3. 或在Linux/Mac使用:
   iconv -f gbk -t utf-8 input.txt > output.txt
```

**问题**: `磁盘空间不足`
```bash
解决方案:
1. 清理临时文件: rm -rf data/temp/*
2. 启用自动清理:
   storage:
     auto_cleanup: true
```

#### 4. 性能问题

**问题**: 处理速度很慢
```yaml
解决方案:
1. 增加并发数(如果网络允许):
   performance:
     max_concurrent_requests: 3

2. 使用更快的模型配置:
   generation:
     image_quality: "normal"  # 而不是"high"
```

**问题**: 内存不足
```yaml
解决方案:
1. 减少图片数量:
   generation:
     max_images: 10  # 而不是15

2. 降低图片分辨率:
   generation:
     output_resolution: "480p"
```

### 日志分析

#### 查看日志
```bash
# 查看最新日志
tail -f logs/app.log

# 查看错误日志
grep ERROR logs/app.log

# 查看特定任务的日志
grep "task_12345" logs/app.log
```

#### 日志级别说明
- **DEBUG**: 详细调试信息
- **INFO**: 正常处理信息  
- **WARNING**: 警告信息
- **ERROR**: 错误信息
- **CRITICAL**: 严重错误

## 📊 输出文件说明

### 生成的文件结构
```
data/output/
├── 小说标题_20250901_143022/
│   ├── final_video.mp4          # 🎬 最终输出视频
│   ├── storyboard.json          # 📝 分镜脚本
│   ├── images/                  # 🖼️ 生成的图片
│   │   ├── scene_001.jpg
│   │   ├── scene_002.jpg
│   │   └── ...
│   ├── videos/                  # 🎥 视频片段
│   │   ├── segment_001.mp4
│   │   ├── segment_002.mp4  
│   │   └── ...
│   ├── audio/                   # 🔊 音频文件
│   │   ├── narration.wav
│   │   └── narration.srt        # 字幕文件
│   └── metadata.json            # 📋 处理元数据
```

### 视频规格
- **分辨率**: 720x1280 (9:16 竖屏)
- **帧率**: 24fps (可配置)
- **编码**: H.264
- **音频**: AAC 48kHz
- **时长**: 2-4分钟 (可配置)

### 质量设置对照

| 质量等级 | 图片尺寸 | 视频码率 | 处理时间 | 成本 |
|---------|---------|---------|---------|------|
| Normal  | 512x512 | 2Mbps   | 5-8分钟  | ¥0.8 |
| High    | 768x768 | 4Mbps   | 8-12分钟 | ¥1.2 |
| Ultra   | 1024x1024| 6Mbps  | 12-20分钟| ¥2.0 |

## 🎯 高级功能

### 1. 自定义提示词

#### 编辑提示词模板
```bash
# 编辑分镜脚本模板
nano prompts/storyboard.txt

# 编辑图片生成模板  
nano prompts/image_prompt.txt

# 编辑视频生成模板
nano prompts/video_prompt.txt
```

#### 示例自定义提示词
```
# prompts/image_prompt.txt
你是一个专业的插画师，请根据以下描述生成高质量的插图:

场景描述: {scene_description}
人物: {characters}
风格要求: 写实风格，电影级别的光影效果
构图: 居中构图，注意景深
色调: 温暖色调，增强情感表达

要求:
1. 画面清晰，细节丰富
2. 人物表情生动
3. 背景与情节呼应
4. 符合9:16竖屏比例
```

### 2. 批处理脚本

#### 创建批处理配置
```bash
# batch_config.yaml
batch:
  input_dir: "novels/"
  output_dir: "output/"  
  max_concurrent: 2
  file_pattern: "*.txt"
  skip_existing: true
  
  # 批处理专用设置
  quality: "normal"        # 批量时使用普通质量
  enable_preview: false    # 关闭预览加快速度
  auto_cleanup: true       # 自动清理临时文件
```

#### 运行批处理
```bash
python batch_process.py --config batch_config.yaml
```

### 3. API监控脚本

#### 创建监控脚本
```python
# monitor.py
import time
from utils.database import DatabaseManager

def monitor_tasks():
    db = DatabaseManager()
    while True:
        stats = db.get_statistics()
        print(f"今日任务: {stats['today_tasks']}")
        print(f"成功率: {stats['success_rate']:.1%}")  
        print(f"今日成本: ¥{stats['today_cost']:.2f}")
        time.sleep(300)  # 每5分钟检查一次

if __name__ == "__main__":
    monitor_tasks()
```

## 🤖 API服务说明

### 火山引擎服务使用
- **豆包大语言模型**: 用于生成分镜脚本
- **文生图服务**: 生成场景插图
- **图生视频服务**: 将图片转换为动态视频
- **TTS语音合成**: 生成旁白音频

### 成本计算公式
```
总成本 = LLM成本 + 文生图成本 + 图生视频成本 + TTS成本

其中:
- LLM成本 = Token数 × 单价(¥0.01/1000tokens)
- 文生图成本 = 图片数 × 单价(¥0.025/张)
- 图生视频成本 = 视频段数 × 单价(¥0.15/段)  
- TTS成本 = 字符数 × 单价(¥0.0005/字符)
```

## 📈 性能优化建议

### 1. 硬件优化
- **CPU**: 多核处理器提升并发性能
- **内存**: 16GB推荐，最低8GB
- **存储**: SSD提升文件读写速度
- **网络**: 稳定的高速网络连接

### 2. 软件配置优化
```yaml
# config.yaml优化配置
performance:
  max_concurrent_requests: 4      # 根据网络情况调整
  request_timeout: 300
  retry_attempts: 3
  connection_pool_size: 10

# 缓存配置
cache:
  enable_image_cache: true        # 启用图片缓存
  enable_audio_cache: true        # 启用音频缓存
  cache_expire_days: 30

# 压缩配置  
compression:
  enable_image_compression: true   # 启用图片压缩
  image_quality: 85               # JPEG质量
  enable_video_compression: true   # 启用视频压缩
```

## 🆘 获取帮助

### 社区支持
- **GitHub Issues**: 报告bug和功能请求
- **文档wiki**: 详细技术文档
- **示例库**: 更多使用示例

### 联系方式
如遇到问题，请按以下顺序排查：

1. **📖 查看文档**: 首先查阅本使用说明
2. **🔍 检查日志**: 查看logs/app.log定位错误
3. **⚙️ 验证配置**: 确认config.yaml配置正确
4. **🌐 测试网络**: 确认API服务可访问
5. **💬 寻求帮助**: 在GitHub提issue或联系开发者

### 常用命令速查

```bash
# 快速开始
python enhanced_main.py

# 命令行处理
python main.py "novel.txt"

# 批量处理
python batch_process.py "novels/"

# 查看状态
python main.py --stats

# 查看成本
python main.py --cost

# 运行测试
python -m pytest tests/

# 清理临时文件
rm -rf data/temp/*
```

---

**版本**: v1.0.0  
**最后更新**: 2025-09-01  
**维护**: auto_movie开发团队

*让AI为你的文字插上视频的翅膀！* 🎬✨