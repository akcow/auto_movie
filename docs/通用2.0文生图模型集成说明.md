# 通用2.0文生图模型集成说明

## 📋 概述

项目已成功集成火山引擎通用2.0文生图模型（`high_aes_general_v20_L`），该模型相比之前的版本具有以下优势：

- **原生中英文双语支持**
- **图文匹配度和美感大幅提升**
- **支持超分功能（开启后分辨率翻倍）**
- **支持prompt扩写功能**

## 🔄 主要变更

### 1. SDK 更换
- **旧版**: 使用 `volcenginesdkarkruntime` (Ark SDK)
- **新版**: 使用 `volcengine.visual.VisualService` (Visual Service SDK)

### 2. API 接口变更
- **旧版**: `client.images.generate()`
- **新版**: `visual_service.cv_process()`

### 3. 请求参数结构调整
```python
# 新的请求参数格式
form = {
    "req_key": "high_aes_general_v20_L",
    "prompt": prompt,
    "seed": -1,
    "scale": 3.5,
    "ddim_steps": 16,
    "width": 512,
    "height": 512,
    "use_sr": True,        # 开启超分功能
    "use_rephraser": True, # 开启prompt扩写
    "return_url": True,
    "logo_info": {
        "add_logo": False,
        "position": 0,
        "language": 0,
        "opacity": 0.3
    }
}
```

## ⚙️ 配置更新

### config.yaml 变更
```yaml
api:
  volcengine:
    # 通用2.0文生图模型API密钥（Visual Service认证）
    access_key_id: "your_access_key_id_here"     # Visual Service的AccessKey ID
    secret_access_key: "your_secret_key_here"   # Visual Service的SecretAccessKey
    region: "cn-north-1"                         # 通用2.0模型使用cn-north-1
    
    # 兼容旧配置（如果只有api_key，也会尝试使用）
    # api_key: "your_legacy_api_key"

models:
  text2image_endpoint: "high_aes_general_v20_L"  # 固定值
```

## 🔑 API密钥配置

### 重要说明
通用2.0文生图模型使用的是 **Visual Service API**，不是 Ark API，需要双重认证配置。

### 密钥格式
```yaml
api:
  volcengine:
    access_key_id: "your_access_key_id_here"    # Visual Service的AccessKey ID
    secret_access_key: "your_secret_key_here"  # Visual Service的SecretAccessKey
    region: "cn-north-1"
```

### 获取API密钥步骤
1. 登录火山引擎控制台 (https://console.volcengine.com/)
2. 进入"访问控制" → "API密钥管理"
3. 创建新的密钥对，获取:
   - AccessKey ID
   - SecretAccessKey
4. 确保密钥有Visual Service的访问权限
5. 在config.yaml中配置上述密钥

## 📦 依赖安装

### 安装新版SDK
```bash
pip uninstall volcengine-sdk-ark  # 卸载旧版SDK（可选）
pip install volcengine           # 安装新版Visual Service SDK
```

### 验证安装
```bash
python -c "from volcengine.visual.VisualService import VisualService; print('安装成功')"
```

## 🚀 使用方法

### 基本使用
```python
from processors.image_gen import ImageGenerator

# 初始化
image_gen = ImageGenerator(config)

# 生成图片
image_data = await image_gen._call_text2image_api("你的提示词")
```

### 高级参数调整
可以在 `_call_text2image_api` 方法中调整以下参数：

- **seed**: 随机种子（-1表示随机）
- **scale**: 文本影响程度（1-30）
- **ddim_steps**: 生成步数（1-50）
- **width/height**: 图像尺寸（256-680）
- **use_sr**: 是否开启超分
- **use_rephraser**: 是否开启prompt扩写

## 🧪 测试验证

### 运行测试脚本
```bash
python test_new_image_model.py
```

### 预期输出
```
============================================================
测试通用2.0文生图模型集成
============================================================
[OK] 配置加载成功
[OK] 图片生成器初始化成功
[OK] 提示词构建成功: ...
[OK] 图片生成成功！耗时: xx.xx秒
[OK] 测试图片已保存到: ./data/temp/test_image_v2.jpg
============================================================
测试完成！
============================================================
```

## 🎯 性能优势

### 1. 图像质量提升
- 支持超分功能，输出分辨率翻倍
- 更好的图文匹配度
- 增强的细节表现力

### 2. 智能功能
- **Prompt扩写**: 自动优化提示词
- **超分增强**: 原生支持2倍超分
- **多风格支持**: 通用类别效果极佳

### 3. 配置灵活
- 可调节生成步数和质量
- 支持随机种子控制
- 灵活的图像尺寸设置

## 🔧 故障排除

### 常见错误及解决方案

#### 1. ImportError: No module named 'volcengine'
```bash
pip install volcengine
```

#### 2. InvalidAccessKey 错误
- 检查API密钥是否为Visual Service密钥
- 确认密钥权限是否包含文生图功能
- 验证区域设置是否正确（cn-north-1）

#### 3. 网络超时
- 在config.yaml中增加request_timeout
- 检查网络连接到火山引擎服务

#### 4. 生成失败
- 检查提示词是否包含敏感内容
- 验证请求参数是否在允许范围内
- 查看火山引擎控制台的服务状态

## 📚 相关文档

- [通用2.0文生图模型说明文档](./docs/通用2.0文生图模型说明文档.md)
- [通用2.0模型SDK使用说明](./docs/通用2.0模型SDK使用说明.md)
- [火山引擎官方文档](https://www.volcengine.com/docs/)

## 🔄 迁移指南

如果您从旧版本迁移：

1. **更新依赖**: 安装新的volcengine SDK
2. **配置密钥**: 获取并配置Visual Service API密钥
3. **更新配置**: 修改config.yaml中的region和endpoint
4. **测试验证**: 运行test_new_image_model.py确认功能正常

---

**注意**: 新模型提供更好的图像质量和更多功能，但需要正确配置API密钥才能正常使用。